"use strict";var __extends=this&&this.__extends||function(){var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])})(e,t)};return function(e,t){function a(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(a.prototype=t.prototype,new a)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,a=1,r=arguments.length;a<r;a++)for(var n in t=arguments[a])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,s,l,i){return new(l=l||Promise)(function(t,a){function r(e){try{o(i.next(e))}catch(e){a(e)}}function n(e){try{o(i.throw(e))}catch(e){a(e)}}function o(e){e.done?t(e.value):function(t){return t instanceof l?t:new l(function(e){e(t)})}(e.value).then(r,n)}o((i=i.apply(e,s||[])).next())})},__generator=this&&this.__generator||function(a,r){var n,o,s,e,l={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;l;)try{if(n=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return l.label++,{value:t[1],done:!1};case 5:l.label++,o=t[1],t=[0];continue;case 7:t=l.ops.pop(),l.trys.pop();continue;default:if(!(s=0<(s=l.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){l=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){l.label=t[1];break}if(6===t[0]&&l.label<s[1]){l.label=s[1],s=t;break}if(s&&l.label<s[2]){l.label=s[2],l.ops.push(t);break}s[2]&&l.ops.pop(),l.trys.pop();continue}t=r.call(a,l)}catch(e){t=[6,e],o=0}finally{n=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__spreadArrays=this&&this.__spreadArrays||function(){for(var e=0,t=0,a=arguments.length;t<a;t++)e+=arguments[t].length;var r=Array(e),n=0;for(t=0;t<a;t++)for(var o=arguments[t],s=0,l=o.length;s<l;s++,n++)r[n]=o[s];return r};exports.__esModule=!0;var react_1=require("react"),react_bootstrap_1=require("react-bootstrap"),react_collapsible_1=require("react-collapsible"),mathjs_1=require("mathjs"),stats_module_1=require("../libs/stats.module"),Constant=require("../constant"),react_csv_1=require("react-csv"),xml_writer_1=require("xml-writer"),d3=require("d3"),headers=[{label:"Node",key:"Node"},{label:"Edge",key:"Edge"},{label:"FPS",key:"FPS"}],headerForLayout=[{label:"iterationCount",key:"iterationCount"},{label:"time",key:"time"},{label:"renderTime",key:"renderTime"}],Sidebar=function(a){function e(e){var t=a.call(this,e)||this;return t.state={nodeData:[],edgeData:[],nodeCount:"",edgeCount:"",laplacian:mathjs_1.sparse([]),adjacencyMatrix:[],e:{},jsonFormat:!0,runBenchmark:!1,FPSData:[],d3timing:[],mouseCapture:!1,mouseEvents:{mouseDown:[],mouseMove:[],mouseUp:[]}},t.handleSubmit=t.handleSubmit.bind(t),t.readFiles=t.readFiles.bind(t),t.generateRandomGraph=t.generateRandomGraph.bind(t),t.generatePair=t.generatePair.bind(t),t.generateRandomData=t.generateRandomData.bind(t),t.refresh=t.refresh.bind(t),t.runTest=t.runTest.bind(t),t.runBenchmark=t.runBenchmark.bind(t),t.testFunc=t.testFunc.bind(t),t.sleep=t.sleep.bind(t),t.storeFPSResult=t.storeFPSResult.bind(t),t.d3TimingStudy=t.d3TimingStudy.bind(t),t.handleMouseDown=t.handleMouseDown.bind(t),t.handleMouseMove=t.handleMouseMove.bind(t),t.handleMouseUp=t.handleMouseUp.bind(t),t.mouseDown=t.mouseDown.bind(t),t.mouseMove=t.mouseMove.bind(t),t.mouseUp=t.mouseUp.bind(t),t}return __extends(e,a),e.prototype.mouseDown=function(e){console.log("i am down"),this.setState({mouseEvents:__assign(__assign({},this.state.mouseEvents),{mouseDown:__spreadArrays(this.state.mouseEvents.mouseDown,[e])})})},e.prototype.mouseUp=function(e){console.log.apply(console,this.state.mouseEvents.mouseUp),this.setState({mouseEvents:__assign(__assign({},this.state.mouseEvents),{mouseUp:__spreadArrays(this.state.mouseEvents.mouseUp,[e])})})},e.prototype.mouseMove=function(e){this.setState({mouseEvents:__assign(__assign({},this.state.mouseEvents),{mouseMove:__spreadArrays(this.state.mouseEvents.mouseMove,[e])})})},e.prototype.handleMouseUp=function(e){e.stopPropogation(),this.setState({mouseCapture:!1})},e.prototype.handleMouseDown=function(e){e.stopPropogation();var t=e.clientX,a=e.clientY;console.log(t,a),this.setState({mouseCapture:!0})},e.prototype.handleMouseMove=function(e){if(this.state.mouseCapture){var t=e.clientX,a=e.clientY;console.log(t,a)}},e.prototype.componentDidMount=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){return(t=document.getElementsByTagName("canvas")[0])&&(t.addEventListener("mousedown",this.mouseDown),t.addEventListener("mousemove",this.mouseMove),t.addEventListener("mouseup",this.mouseUp)),[2]})})},e.prototype.componentWillUnmount=function(){var e=document.getElementsByTagName("canvas")[0];e&&(e.removeEventListener("mousedown",this.mouseDown),e.removeEventListener("mousemove",this.mouseMove),e.removeEventListener("mouseup",this.mouseUp))},e.prototype.handleSubmit=function(e){e.preventDefault(),this.props.setNodeEdgeData(this.state.nodeData,this.state.edgeData)},e.prototype.sleep=function(t){return new Promise(function(e){setTimeout(e,t)})},e.prototype.d3TimingStudy=function(r){return __awaiter(this,void 0,void 0,function(){var l,o,i,u,c,d,t,a,p;return __generator(this,function(e){return r.preventDefault(),l=this,800,o=0,i={},t=d3.select("#graphDiv").append("canvas").attr("width","800px").attr("height","800px").node(),(a=document.getElementById("#graphDiv"))&&(a.style.color="white"),(p=t.getContext("2d"))?(p.fillStyle="white",d3.json("./sample_test_data/sample_data100_2000.json").then(function(n){console.log(n);u=performance.now(),c=u;var s=d3.forceSimulation(n.nodes).force("charge",d3.forceManyBody().strength(-40)).force("center",d3.forceCenter(400,400)).force("link",d3.forceLink(n.edges).distance(400).strength(2));function t(){var e=performance.now(),t=e-c;i[++o]=t,c=e;var a=performance.now();p.save(),p.clearRect(0,0,800,800),n.edges.forEach(function(e,t){0==t&&console.log(e.source.x),p.beginPath(),p.strokeStyle="rgba(0.0, 0.0, 0.0, 0.08)",p.moveTo(e.source.x,e.source.y),p.lineTo(e.target.x,e.target.y),p.stroke()}),n.nodes.forEach(function(e){p.beginPath(),p.arc(e.x,e.y,2,0,2*Math.PI,!0),p.fillStyle=e.col?"red":"black",p.fill()}),p.restore();var r=performance.now()-a;l.setState({d3timing:__spreadArrays(l.state.d3timing,[{iterationCount:o,totalTime:t,renderingTime:r}])})}!function(){var e=this;s.on("tick",t),s.on("end",function(){return __awaiter(e,void 0,void 0,function(){var t,a,r,n,o;return __generator(this,function(e){switch(e.label){case 0:return s.nodes(),performance.now(),[4,l.props.setNodeEdgeData(l.state.nodeData,l.state.edgeData)];case 1:return e.sent(),performance.now(),t=performance.now(),d=t-u,a=function(e){var t=e.reduce(function(e,t){return e+t.totalTime},0)/e.length,a=e.reduce(function(e,t){return e+t.renderingTime},0)/e.length,r=e.reduce(function(e,t){return e+(t.totalTime-t.renderingTime)},0)/e.length;return[t,r,a]}(l.state.d3timing),r=a[0],n=a[1],o=a[2],console.log("totalAverageTime",r,"layoutAverageTime",n,"averageTimetoRender",o),console.log("totalTime",d-0),[2]}})})})}()})):console.log("no 2d context found"),[2]})})},e.prototype.runBenchmark=function(c){return __awaiter(this,void 0,void 0,function(){var t,a,r,n,o,s,l,i,u;return __generator(this,function(e){switch(e.label){case 0:e.trys.push([0,5,,6]),c.preventDefault(),20,a=(t=[100,1e3,2e3,5e3,1e4]).map(function(e){return 20*e}),this.setState({runBenchmark:!0}),(r=document.querySelectorAll("canvas")[0]).width=500,r.height=500,r.style.width="500px",r.style.height="500px",n=0,e.label=1;case 1:return n<t.length?((o=stats_module_1.default()).showPanel(0),o.dom.setAttribute("class","status"),document.body.appendChild(o.dom),s=t[n].toString(),l=a[n].toString(),this.setState({nodeCount:s}),this.setState({edgeCount:l}),i=this.generateRandomData(t,a,n),this.setState({nodeData:i.nodes}),this.setState({edgeData:i.edges}),[4,this.testFunc(i,o)]):[3,4];case 2:e.sent(),e.label=3;case 3:return n++,[3,1];case 4:return this.setState({runBenchmark:!1}),r.width=800,r.height=800,r.style.width="800px",r.style.height="800px",[3,6];case 5:return u=e.sent(),console.log(u),[3,6];case 6:return[2]}})})},e.prototype.generatePair=function(e,t){function a(e,t){return e+Math.floor(Math.random()*(t-e))}for(var r=a(e,t),n=a(e,t);r===n;)n=a(e,t);return{source:r,target:n}},e.prototype.generateRandomData=function(e,t,a){var r=e[a],n=t[a];return this.generateRandomGraph(r,n)},e.prototype.generateRandomGraph=function(e,t){var a,r={nodes:[],edges:[]};r.nodes=Array(4*e).fill(0);for(var n=0;n<4*e;n+=4)r.nodes[n]=0,r.nodes[n+1]=Math.random(),r.nodes[n+2]=Math.random(),r.nodes[n+3]=1;r.edges=Array(2*t).fill(0);for(n=0;n<2*t;n+=2)a=this.generatePair(0,e),r.edges[n]=a.source,r.edges[n+1]=a.target;return console.log("data generated"),r},e.prototype.refresh=function(e){try{for(var t=[],a=0;a<4*e;a+=4)t[a+1]=Math.random(),t[a+2]=Math.random();this.setState({nodeData:t}),this.props.setNodeEdgeData(t,this.state.edgeData)}catch(e){console.error(e)}},e.prototype.storeFPSResult=function(e,t,a){e=e.toString(),t=t.toString(),a=a.toString(),this.setState({FPSData:__spreadArrays(this.state.FPSData,[[e,t,a]])})},e.prototype.testFunc=function(r,n){return __awaiter(this,void 0,void 0,function(){var t,a;return __generator(this,function(e){switch(e.label){case 0:return t=r.nodes.length/4,a=r.edges.length/2,console.log(t),[4,this.runTest(t,a,n)];case 1:return e.sent(),[2]}})})},e.prototype.runTest=function(l,i,u){return __awaiter(this,void 0,void 0,function(){var t,a,r,n,o,s=this;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),0,(a=function(){u.begin(),s.refresh(l),u.end(),t=requestAnimationFrame(a)})(),[4,this.sleep(Constant.TIME_FOR_EACH_TEST)];case 1:return e.sent(),r=u.getFPSHistory(),console.log(r),n=r.reduce(function(e,t){return e+t},0)/r.length,this.storeFPSResult(l,i,n),cancelAnimationFrame(t),[2];case 2:return o=e.sent(),console.error(o),[3,3];case 3:return[2]}})})},e.prototype.readFiles=function(e){var s=this,l=e.target.files;console.log(l);var i={},u={},c=[],o=[],d=[],p=[],m=new FileReader;m.onload=function(e){for(var t=0,a=m.result.split("\n");t<a.length;t++){var r=a[t].split("\t");i[r[0]]&&i[r[1]]&&(o.push(u[r[0]],u[r[1]]),d[u[r[0]]][u[r[0]]]+=1,d[u[r[1]]][u[r[1]]]+=1,p[u[r[0]]][u[r[1]]]+=1,p[u[r[1]]][u[r[0]]]+=1)}console.log(o),s.setState({edgeData:o});var n=mathjs_1.subtract(mathjs_1.sparse(d),mathjs_1.sparse(p));console.log(n),s.setState({laplacian:n,adjacencyMatrix:p})};var h=new FileReader;h.onload=function(e){for(var t=0,a=h.result.split("\n");t<a.length;t++){var r=a[t].split("\t");i[r[0]]&&(u[r[0]]=c.length/4,c.push(parseFloat(i[r[0]]),parseFloat(r[1]),parseFloat(r[2]),parseFloat(r[3])))}s.setState({nodeData:c});for(var n=0;n<c.length/4;n++){d.push([]),p.push([]);for(var o=0;o<c.length/4;o++)d[n].push(0),p[n].push(0)}m.readAsText(l[2])};var n=new FileReader;n.onload=function(e){for(var t=0,a=n.result.split("\n");t<a.length;t++){var r=a[t];i[r.split("\t")[0]]=r.split("\t")[1]}console.log(i),h.readAsText(l[1])},n.readAsText(l[0])},e.prototype.readJson=function(e){var l=this,t=e.target.files,i=new FileReader,u=[],c=[],d=[];i.onload=function(e){var t=JSON.parse(i.result);console.log(t);for(var a=0;a<t.nodes.length;a++)if(t.nodes[a].x)u.push(0,t.nodes[a].x,t.nodes[a].y,1),c.push([t.nodes[a].x,t.nodes[a].y,a]);else{var r=Math.random(),n=Math.random();u.push(0,r,n,1),c.push([r,n,a])}for(a=0;a<t.edges.length;a++){var o=t.edges[a].source,s=t.edges[a].target;d.push(o,s)}l.setState({nodeData:u,edgeData:d}),console.log(d)},i.readAsText(t[0])},e.prototype.applySpectral=function(){var e=mathjs_1.eigs(this.state.laplacian);console.log(e);for(var t=this.state.nodeData,a=mathjs_1.column(e.vectors,1),r=mathjs_1.column(e.vectors,2),n=mathjs_1.max(a),o=mathjs_1.max(r),s=mathjs_1.min(a),l=mathjs_1.min(r),i=0;i<t.length/4;i++)t[4*i+1]=(a.get([i,0])-s)/(n-s),t[4*i+2]=(r.get([i,0])-l)/(o-l);this.setState({nodeData:t}),this.props.setNodeEdgeData(t,this.state.edgeData)},e.prototype.onSaveXML=function(){var e=new xml_writer_1.default(!0);e.startDocument(),e.startElement("GeneTerrain"),e.startElement("Nodes");for(var t=0;t<this.state.nodeData.length;t+=4)e.startElement("Node"),e.writeAttribute("NodeID",t/4),e.writeAttribute("InputValue",this.state.nodeData[t]),e.writeAttribute("InputWeight",this.state.nodeData[t+3]),e.writeAttribute("NodeBackendX",this.state.nodeData[t+1]),e.writeAttribute("NodeBackendY",this.state.nodeData[t+2]),e.endElement("Node");e.endElement("Nodes"),e.startElement("Edges");for(t=0;t<this.state.edgeData.length;t+=2)e.startElement("Edge"),e.writeAttribute("BeginID",this.state.edgeData[t]),e.writeAttribute("EndID",this.state.edgeData[t+1]),e.endElement("Edge");e.endElement("Edges"),e.endDocument();var a=document.createElement("a"),r=new Blob([e.toString()],{type:"application/xml"});a.href=URL.createObjectURL(r),a.download="terrain.xml",document.body.appendChild(a),a.click()},e.prototype.render=function(){var t=this;return react_1.default.createElement("div",{className:"sidebar"},react_1.default.createElement("hr",null),react_1.default.createElement(react_bootstrap_1.Button,{className:"benchmark_test",onClick:this.runBenchmark},"Run Benchmark"),react_1.default.createElement("div",{style:{margin:10,color:"white"}},react_1.default.createElement("p",null,"Node count: ",this.state.nodeCount),react_1.default.createElement("p",null,"Edge count: ",this.state.edgeCount)),react_1.default.createElement(react_csv_1.CSVLink,{data:this.state.FPSData},"Download FPS data"),react_1.default.createElement("hr",null),react_1.default.createElement(react_bootstrap_1.Button,{className:"d3Timing_test",onClick:this.d3TimingStudy},"Run D3"),react_1.default.createElement(react_csv_1.CSVLink,{data:this.state.d3timing,header:headerForLayout},"Download FPS data"),react_1.default.createElement(react_bootstrap_1.Form,{style:{color:"white"},onSubmit:this.handleSubmit},react_1.default.createElement(react_bootstrap_1.Form.Group,{controlId:"formFile",className:"mt-3 mb-3"},react_1.default.createElement(react_bootstrap_1.Form.Check,{defaultChecked:!0,onClick:function(){return t.setState({jsonFormat:!t.state.jsonFormat})},type:"checkbox",label:"Json Format"}),react_1.default.createElement(react_bootstrap_1.Form.Label,null,"Select Example Files"),react_1.default.createElement(react_bootstrap_1.Form.Control,{className:"form-control",type:"file",multiple:!0,onChange:function(e){t.state.jsonFormat?t.readJson(e):t.readFiles(e)}}),react_1.default.createElement(react_bootstrap_1.Button,{className:"mt-2",type:"submit",variant:"secondary",value:"Submit"},"Submit")),react_1.default.createElement(react_collapsible_1.default,{trigger:"Terrain Options"},react_1.default.createElement(react_bootstrap_1.Form.Group,null,react_1.default.createElement(react_bootstrap_1.Form.Label,null," Width Factor "),react_1.default.createElement("br",null),react_1.default.createElement("input",{type:"range",defaultValue:1e3,min:0,max:2e3,onChange:function(e){return t.props.setWidthFactor(parseFloat(e.target.value))}})),react_1.default.createElement(react_bootstrap_1.Form.Group,null,react_1.default.createElement(react_bootstrap_1.Form.Label,null," Peak and Valley Values "),react_1.default.createElement("br",null),react_1.default.createElement("input",{type:"range",defaultValue:.8,min:.5,max:1,step:.01,onChange:function(e){return t.props.setPeakValue(parseFloat(e.target.value))}}),react_1.default.createElement("input",{type:"range",defaultValue:.2,min:0,max:.5,step:.01,onChange:function(e){return t.props.setValleyValue(parseFloat(e.target.value))}})),react_1.default.createElement(react_bootstrap_1.Form.Group,null,react_1.default.createElement(react_bootstrap_1.Form.Check,{defaultChecked:!0,onClick:function(e){return t.props.setGlobalRange()},type:"checkbox",label:"Use Global Min/Max"}))),react_1.default.createElement(react_collapsible_1.default,{trigger:"Colormap Options"},react_1.default.createElement(react_bootstrap_1.Form.Row,null,react_1.default.createElement("div",null,"Valley"),react_1.default.createElement("input",{type:"range",defaultValue:45,min:1,max:60,step:1,onChange:function(e){return t.props.setColorValley(parseFloat(e.target.value))}})),react_1.default.createElement(react_bootstrap_1.Form.Row,null,react_1.default.createElement("div",null,"Hill"),react_1.default.createElement("input",{type:"range",defaultValue:90,min:61,max:120,step:1,onChange:function(e){return t.props.setColorHill(parseFloat(e.target.value))}})),react_1.default.createElement(react_bootstrap_1.Form.Row,null,react_1.default.createElement("div",null,"Mountain"),react_1.default.createElement("input",{type:"range",defaultValue:135,min:121,max:180,step:1,onChange:function(e){return t.props.setColorMountain(parseFloat(e.target.value))}}))),react_1.default.createElement(react_collapsible_1.default,{trigger:"Layers"},react_1.default.createElement(react_bootstrap_1.Form.Check,{defaultChecked:!1,onClick:function(e){return t.props.toggleTerrainLayer()},type:"checkbox",label:"Terrain Layer"}),react_1.default.createElement(react_bootstrap_1.Form.Check,{defaultChecked:!0,onClick:function(e){return t.props.toggleNodeLayer()},type:"checkbox",label:"Node Layer"}),react_1.default.createElement(react_bootstrap_1.Form.Check,{defaultChecked:!0,onClick:function(e){return t.props.toggleEdgeLayer()},type:"checkbox",label:"Edge Layer"})),react_1.default.createElement(react_collapsible_1.default,{trigger:"Force Directed Options"},react_1.default.createElement(react_bootstrap_1.Form.Label,null," Ideal Length and Cooling Factor "),react_1.default.createElement("br",null),react_1.default.createElement("input",{type:"range",defaultValue:.05,min:.001,max:.1,step:.001,onChange:function(e){return t.props.setIdealLength(parseFloat(e.target.value))}}),react_1.default.createElement("input",{type:"range",defaultValue:.9,min:.75,max:.999,step:.001,onChange:function(e){return t.props.setCoolingFactor(parseFloat(e.target.value))}})),react_1.default.createElement(react_bootstrap_1.Button,{onClick:function(e){return t.props.onSave()}},"Save Terrain"),react_1.default.createElement("br",null),react_1.default.createElement(react_bootstrap_1.Button,{onClick:function(e){return t.applySpectral()}},"Apply Spectral Layout"),react_1.default.createElement("br",null),react_1.default.createElement(react_bootstrap_1.Button,{onClick:function(e){console.log(t.state.mouseEvents)}},"Show Event"),react_1.default.createElement(react_bootstrap_1.Button,{onClick:function(e){return t.props.runForceDirected()}},"Run Force Directed Layout"),react_1.default.createElement("br",null),react_1.default.createElement(react_bootstrap_1.Button,{onClick:function(e){return t.onSaveXML()}},"Save Terrain to XML")))},e}(react_1.default.Component);exports.default=Sidebar;
//# sourceMappingURL=Sidebar.min.js.map
