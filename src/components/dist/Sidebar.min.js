"use strict";var __extends=this&&this.__extends||function(){var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])})(e,t)};return function(e,t){function a(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(a.prototype=t.prototype,new a)}}(),__awaiter=this&&this.__awaiter||function(e,l,s,c){return new(s=s||Promise)(function(t,a){function r(e){try{o(c.next(e))}catch(e){a(e)}}function n(e){try{o(c.throw(e))}catch(e){a(e)}}function o(e){e.done?t(e.value):function(t){return t instanceof s?t:new s(function(e){e(t)})}(e.value).then(r,n)}o((c=c.apply(e,l||[])).next())})},__generator=this&&this.__generator||function(a,r){var n,o,l,e,s={label:0,sent:function(){if(1&l[0])throw l[1];return l[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,o&&(l=2&t[0]?o.return:t[0]?o.throw||((l=o.return)&&l.call(o),0):o.next)&&!(l=l.call(o,t[1])).done)return l;switch(o=0,l&&(t=[2&t[0],l.value]),t[0]){case 0:case 1:l=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,o=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(l=0<(l=s.trys).length&&l[l.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!l||t[1]>l[0]&&t[1]<l[3])){s.label=t[1];break}if(6===t[0]&&s.label<l[1]){s.label=l[1],l=t;break}if(l&&s.label<l[2]){s.label=l[2],s.ops.push(t);break}l[2]&&s.ops.pop(),s.trys.pop();continue}t=r.call(a,s)}catch(e){t=[6,e],o=0}finally{n=l=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__spreadArrays=this&&this.__spreadArrays||function(){for(var e=0,t=0,a=arguments.length;t<a;t++)e+=arguments[t].length;var r=Array(e),n=0;for(t=0;t<a;t++)for(var o=arguments[t],l=0,s=o.length;l<s;l++,n++)r[n]=o[l];return r};exports.__esModule=!0;var react_1=require("react"),react_bootstrap_1=require("react-bootstrap"),react_collapsible_1=require("react-collapsible"),mathjs_1=require("mathjs"),stats_module_1=require("../libs/stats.module"),Constant=require("../constant"),react_csv_1=require("react-csv"),xml_writer_1=require("xml-writer"),d3=require("d3"),headers=[{label:"Node",key:"Node"},{label:"Edge",key:"Edge"},{label:"FPS",key:"FPS"}],headerForLayout=[{label:"iterationCount",key:"iterationCount"},{label:"time",key:"time"},{label:"renderTime",key:"renderTime"}],Sidebar=function(a){function e(e){var t=a.call(this,e)||this;return t.state={nodeData:[],edgeData:[],nodeCount:"",edgeCount:"",laplacian:mathjs_1.sparse([]),adjacencyMatrix:[],e:{},jsonFormat:!0,runBenchmark:!1,FPSData:[],d3timing:[]},t.handleSubmit=t.handleSubmit.bind(t),t.readFiles=t.readFiles.bind(t),t.generateRandomGraph=t.generateRandomGraph.bind(t),t.generatePair=t.generatePair.bind(t),t.generateRandomData=t.generateRandomData.bind(t),t.refresh=t.refresh.bind(t),t.runTest=t.runTest.bind(t),t.runBenchmark=t.runBenchmark.bind(t),t.testFunc=t.testFunc.bind(t),t.sleep=t.sleep.bind(t),t.storeFPSResult=t.storeFPSResult.bind(t),t.d3TimingStudy=t.d3TimingStudy.bind(t),t}return __extends(e,a),e.prototype.handleSubmit=function(e){e.preventDefault(),this.props.setNodeEdgeData(this.state.nodeData,this.state.edgeData)},e.prototype.sleep=function(t){return new Promise(function(e){setTimeout(e,t)})},e.prototype.d3TimingStudy=function(t){return __awaiter(this,void 0,void 0,function(){var c,i,u,o,d;return __generator(this,function(e){return t.preventDefault(),c=this,800,i=0,u={},d3.json("./sample_test_data/sample_data10000_200000.json").then(function(l){console.log(l);var s=0;o=performance.now(),o;var e=d3.forceSimulation(l.nodes).force("charge",d3.forceManyBody().strength(-40)).force("center",d3.forceCenter(400,400)).force("link",d3.forceLink(l.edges).distance(400).strength(2)).alphaDecay(.077);function t(){var e=performance.now(),t=function(e,t){var a={nodes:[],edges:[]},r=e.length;a.nodes=Array(4*r).fill(0);for(var n=0,o=0,l=0;l<4*r;l+=4){a.nodes[l]=0;var s=Math.abs(e[l/4].x),c=Math.abs(e[l/4].y);n<s&&(n=s),o<c&&(o=c),a.nodes[l+3]=1}for(l=0;l<4*r;l+=4)a.nodes[l+1]=e[l/4].x/n,a.nodes[l+2]=e[l/4].y/o;for(a.edges=Array(2*r*20).fill(0),l=0;l<40*r;l+=2)a.edges[l]=parseInt(t[l/2].source.name),a.edges[l+1]=parseInt(t[l/2].target.name);return a}(l.nodes,l.edges),a=performance.now()-e;s+=a;var r=performance.now();c.setState({nodeData:t.nodes}),c.props.setNodeEdgeData(t.nodes,t.edges);var n=performance.now()-r,o=performance.now()-e-a;i++,console.log(i),u[i]=o,c.setState({d3timing:__spreadArrays(c.state.d3timing,[{iterationCount:i,totalTime:o,renderingTime:n}])})}e.on("tick",t),e.on("end",function(){var e=performance.now();d=e-o-s;var t=function(e){var t=e.reduce(function(e,t){return e+t.totalTime},0)/e.length,a=e.reduce(function(e,t){return e+t.renderingTime},0)/e.length,r=e.reduce(function(e,t){return e+(t.totalTime-t.renderingTime)},0)/e.length;return[t,r,a]}(c.state.d3timing),a=t[0],r=t[1],n=t[2];console.log("totalAverageTime",a,"layoutAverageTime",r,"averageTimetoRender",n),console.log("totalTime",d)})}),[2]})})},e.prototype.runBenchmark=function(u){return __awaiter(this,void 0,void 0,function(){var t,a,r,n,o,l,s,c,i;return __generator(this,function(e){switch(e.label){case 0:e.trys.push([0,5,,6]),u.preventDefault(),20,a=(t=[100,1e3,2e3,5e3,1e4]).map(function(e){return 20*e}),this.setState({runBenchmark:!0}),(r=document.querySelectorAll("canvas")[0]).width=500,r.height=500,r.style.width="500px",r.style.height="500px",n=0,e.label=1;case 1:return n<t.length?((o=stats_module_1.default()).showPanel(0),o.dom.setAttribute("class","status"),document.body.appendChild(o.dom),l=t[n].toString(),s=a[n].toString(),this.setState({nodeCount:l}),this.setState({edgeCount:s}),c=this.generateRandomData(t,a,n),this.setState({nodeData:c.nodes}),this.setState({edgeData:c.edges}),[4,this.testFunc(c,o)]):[3,4];case 2:e.sent(),e.label=3;case 3:return n++,[3,1];case 4:return this.setState({runBenchmark:!1}),r.width=800,r.height=800,r.style.width="800px",r.style.height="800px",[3,6];case 5:return i=e.sent(),console.log(i),[3,6];case 6:return[2]}})})},e.prototype.generatePair=function(e,t){function a(e,t){return e+Math.floor(Math.random()*(t-e))}for(var r=a(e,t),n=a(e,t);r===n;)n=a(e,t);return{source:r,target:n}},e.prototype.generateRandomData=function(e,t,a){var r=e[a],n=t[a];return this.generateRandomGraph(r,n)},e.prototype.generateRandomGraph=function(e,t){var a,r={nodes:[],edges:[]};r.nodes=Array(4*e).fill(0);for(var n=0;n<4*e;n+=4)r.nodes[n]=0,r.nodes[n+1]=Math.random(),r.nodes[n+2]=Math.random(),r.nodes[n+3]=1;r.edges=Array(2*t).fill(0);for(n=0;n<2*t;n+=2)a=this.generatePair(0,e),r.edges[n]=a.source,r.edges[n+1]=a.target;return console.log("data generated"),r},e.prototype.refresh=function(e){try{for(var t=[],a=0;a<4*e;a+=4)t[a+1]=Math.random(),t[a+2]=Math.random();this.setState({nodeData:t}),this.props.setNodeEdgeData(t,this.state.edgeData)}catch(e){console.error(e)}},e.prototype.storeFPSResult=function(e,t,a){e=e.toString(),t=t.toString(),a=a.toString(),this.setState({FPSData:__spreadArrays(this.state.FPSData,[[e,t,a]])})},e.prototype.testFunc=function(r,n){return __awaiter(this,void 0,void 0,function(){var t,a;return __generator(this,function(e){switch(e.label){case 0:return t=r.nodes.length/4,a=r.edges.length/2,console.log(t),[4,this.runTest(t,a,n)];case 1:return e.sent(),[2]}})})},e.prototype.runTest=function(s,c,i){return __awaiter(this,void 0,void 0,function(){var t,a,r,n,o,l=this;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),0,(a=function(){i.begin(),l.refresh(s),i.end(),t=requestAnimationFrame(a)})(),[4,this.sleep(Constant.TIME_FOR_EACH_TEST)];case 1:return e.sent(),r=i.getFPSHistory(),console.log(r),n=r.reduce(function(e,t){return e+t},0)/r.length,this.storeFPSResult(s,c,n),cancelAnimationFrame(t),[2];case 2:return o=e.sent(),console.error(o),[3,3];case 3:return[2]}})})},e.prototype.readFiles=function(e){var l=this,s=e.target.files;console.log(s);var c={},i={},u=[],o=[],d=[],p=[],m=new FileReader;m.onload=function(e){for(var t=0,a=m.result.split("\n");t<a.length;t++){var r=a[t].split("\t");c[r[0]]&&c[r[1]]&&(o.push(i[r[0]],i[r[1]]),d[i[r[0]]][i[r[0]]]+=1,d[i[r[1]]][i[r[1]]]+=1,p[i[r[0]]][i[r[1]]]+=1,p[i[r[1]]][i[r[0]]]+=1)}l.setState({edgeData:o});var n=mathjs_1.subtract(mathjs_1.sparse(d),mathjs_1.sparse(p));console.log(n),l.setState({laplacian:n,adjacencyMatrix:p})};var f=new FileReader;f.onload=function(e){for(var t=0,a=f.result.split("\n");t<a.length;t++){var r=a[t].split("\t");c[r[0]]&&(i[r[0]]=u.length/4,u.push(parseFloat(c[r[0]]),parseFloat(r[1]),parseFloat(r[2]),parseFloat(r[3])))}l.setState({nodeData:u});for(var n=0;n<u.length/4;n++){d.push([]),p.push([]);for(var o=0;o<u.length/4;o++)d[n].push(0),p[n].push(0)}m.readAsText(s[2])};var n=new FileReader;n.onload=function(e){for(var t=0,a=n.result.split("\n");t<a.length;t++){var r=a[t];c[r.split("\t")[0]]=r.split("\t")[1]}console.log(c),f.readAsText(s[1])},n.readAsText(s[0])},e.prototype.readJson=function(e){var o=this,t=e.target.files,l=new FileReader,s=[],c=[];l.onload=function(e){var t=JSON.parse(l.result);console.log(t);for(var a=0;a<t.nodes.length;a++)t.nodes[a].x?s.push(0,t.nodes[a].x,t.nodes[a].y,1):s.push(0,Math.random(),Math.random(),1);for(a=0;a<t.edges.length;a++){var r=t.edges[a].source,n=t.edges[a].target;c.push(r,n)}o.setState({nodeData:s,edgeData:c})},l.readAsText(t[0])},e.prototype.applySpectral=function(){var e=mathjs_1.eigs(this.state.laplacian);console.log(e);for(var t=this.state.nodeData,a=mathjs_1.column(e.vectors,1),r=mathjs_1.column(e.vectors,2),n=mathjs_1.max(a),o=mathjs_1.max(r),l=mathjs_1.min(a),s=mathjs_1.min(r),c=0;c<t.length/4;c++)t[4*c+1]=(a.get([c,0])-l)/(n-l),t[4*c+2]=(r.get([c,0])-s)/(o-s);this.setState({nodeData:t}),this.props.setNodeEdgeData(t,this.state.edgeData)},e.prototype.onSaveXML=function(){var e=new xml_writer_1.default(!0);e.startDocument(),e.startElement("GeneTerrain"),e.startElement("Nodes");for(var t=0;t<this.state.nodeData.length;t+=4)e.startElement("Node"),e.writeAttribute("NodeID",t/4),e.writeAttribute("InputValue",this.state.nodeData[t]),e.writeAttribute("InputWeight",this.state.nodeData[t+3]),e.writeAttribute("NodeBackendX",this.state.nodeData[t+1]),e.writeAttribute("NodeBackendY",this.state.nodeData[t+2]),e.endElement("Node");e.endElement("Nodes"),e.startElement("Edges");for(t=0;t<this.state.edgeData.length;t+=2)e.startElement("Edge"),e.writeAttribute("BeginID",this.state.edgeData[t]),e.writeAttribute("EndID",this.state.edgeData[t+1]),e.endElement("Edge");e.endElement("Edges"),e.endDocument();var a=document.createElement("a"),r=new Blob([e.toString()],{type:"application/xml"});a.href=URL.createObjectURL(r),a.download="terrain.xml",document.body.appendChild(a),a.click()},e.prototype.render=function(){var t=this;return react_1.default.createElement("div",{className:"sidebar"},react_1.default.createElement("hr",null),react_1.default.createElement(react_bootstrap_1.Button,{className:"benchmark_test",onClick:this.runBenchmark},"Run Benchmark"),react_1.default.createElement("div",{style:{margin:10,color:"white"}},react_1.default.createElement("p",null,"Node count: ",this.state.nodeCount),react_1.default.createElement("p",null,"Edge count: ",this.state.edgeCount)),react_1.default.createElement(react_csv_1.CSVLink,{data:this.state.FPSData},"Download FPS data"),react_1.default.createElement("hr",null),react_1.default.createElement(react_bootstrap_1.Button,{className:"d3Timing_test",onClick:this.d3TimingStudy},"Run D3"),react_1.default.createElement(react_csv_1.CSVLink,{data:this.state.d3timing,header:headerForLayout},"Download FPS data"),react_1.default.createElement(react_bootstrap_1.Form,{style:{color:"white"},onSubmit:this.handleSubmit},react_1.default.createElement(react_bootstrap_1.Form.Group,{controlId:"formFile",className:"mt-3 mb-3"},react_1.default.createElement(react_bootstrap_1.Form.Check,{defaultChecked:!0,onClick:function(){return t.setState({jsonFormat:!t.state.jsonFormat})},type:"checkbox",label:"Json Format"}),react_1.default.createElement(react_bootstrap_1.Form.Label,null,"Select Example Files"),react_1.default.createElement(react_bootstrap_1.Form.Control,{className:"form-control",type:"file",multiple:!0,onChange:function(e){t.state.jsonFormat?t.readJson(e):t.readFiles(e)}}),react_1.default.createElement(react_bootstrap_1.Button,{className:"mt-2",type:"submit",variant:"secondary",value:"Submit"},"Submit")),react_1.default.createElement(react_collapsible_1.default,{trigger:"Terrain Options"},react_1.default.createElement(react_bootstrap_1.Form.Group,null,react_1.default.createElement(react_bootstrap_1.Form.Label,null," Width Factor "),react_1.default.createElement("br",null),react_1.default.createElement("input",{type:"range",defaultValue:1e3,min:0,max:2e3,onChange:function(e){return t.props.setWidthFactor(parseFloat(e.target.value))}})),react_1.default.createElement(react_bootstrap_1.Form.Group,null,react_1.default.createElement(react_bootstrap_1.Form.Label,null," Peak and Valley Values "),react_1.default.createElement("br",null),react_1.default.createElement("input",{type:"range",defaultValue:.8,min:.5,max:1,step:.01,onChange:function(e){return t.props.setPeakValue(parseFloat(e.target.value))}}),react_1.default.createElement("input",{type:"range",defaultValue:.2,min:0,max:.5,step:.01,onChange:function(e){return t.props.setValleyValue(parseFloat(e.target.value))}})),react_1.default.createElement(react_bootstrap_1.Form.Group,null,react_1.default.createElement(react_bootstrap_1.Form.Check,{defaultChecked:!0,onClick:function(e){return t.props.setGlobalRange()},type:"checkbox",label:"Use Global Min/Max"}))),react_1.default.createElement(react_collapsible_1.default,{trigger:"Colormap Options"},react_1.default.createElement(react_bootstrap_1.Form.Row,null,react_1.default.createElement("div",null,"Valley"),react_1.default.createElement("input",{type:"range",defaultValue:45,min:1,max:60,step:1,onChange:function(e){return t.props.setColorValley(parseFloat(e.target.value))}})),react_1.default.createElement(react_bootstrap_1.Form.Row,null,react_1.default.createElement("div",null,"Hill"),react_1.default.createElement("input",{type:"range",defaultValue:90,min:61,max:120,step:1,onChange:function(e){return t.props.setColorHill(parseFloat(e.target.value))}})),react_1.default.createElement(react_bootstrap_1.Form.Row,null,react_1.default.createElement("div",null,"Mountain"),react_1.default.createElement("input",{type:"range",defaultValue:135,min:121,max:180,step:1,onChange:function(e){return t.props.setColorMountain(parseFloat(e.target.value))}}))),react_1.default.createElement(react_collapsible_1.default,{trigger:"Layers"},react_1.default.createElement(react_bootstrap_1.Form.Check,{defaultChecked:!1,onClick:function(e){return t.props.toggleTerrainLayer()},type:"checkbox",label:"Terrain Layer"}),react_1.default.createElement(react_bootstrap_1.Form.Check,{defaultChecked:!0,onClick:function(e){return t.props.toggleNodeLayer()},type:"checkbox",label:"Node Layer"}),react_1.default.createElement(react_bootstrap_1.Form.Check,{defaultChecked:!0,onClick:function(e){return t.props.toggleEdgeLayer()},type:"checkbox",label:"Edge Layer"})),react_1.default.createElement(react_collapsible_1.default,{trigger:"Force Directed Options"},react_1.default.createElement(react_bootstrap_1.Form.Label,null," Ideal Length and Cooling Factor "),react_1.default.createElement("br",null),react_1.default.createElement("input",{type:"range",defaultValue:.05,min:.001,max:.1,step:.001,onChange:function(e){return t.props.setIdealLength(parseFloat(e.target.value))}}),react_1.default.createElement("input",{type:"range",defaultValue:.9,min:.75,max:.999,step:.001,onChange:function(e){return t.props.setCoolingFactor(parseFloat(e.target.value))}})),react_1.default.createElement(react_bootstrap_1.Button,{onClick:function(e){return t.props.onSave()}},"Save Terrain"),react_1.default.createElement("br",null),react_1.default.createElement(react_bootstrap_1.Button,{onClick:function(e){return t.applySpectral()}},"Apply Spectral Layout"),react_1.default.createElement("br",null),react_1.default.createElement(react_bootstrap_1.Button,{onClick:function(e){return t.props.runForceDirected()}},"Run Force Directed Layout"),react_1.default.createElement("br",null),react_1.default.createElement(react_bootstrap_1.Button,{onClick:function(e){return t.onSaveXML()}},"Save Terrain to XML")))},e}(react_1.default.Component);exports.default=Sidebar;
//# sourceMappingURL=Sidebar.min.js.map
