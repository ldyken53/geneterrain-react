"use strict";var __extends=this&&this.__extends||function(){var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])})(e,t)};return function(e,t){function a(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(a.prototype=t.prototype,new a)}}(),__awaiter=this&&this.__awaiter||function(e,l,s,c){return new(s=s||Promise)(function(t,a){function r(e){try{o(c.next(e))}catch(e){a(e)}}function n(e){try{o(c.throw(e))}catch(e){a(e)}}function o(e){e.done?t(e.value):function(t){return t instanceof s?t:new s(function(e){e(t)})}(e.value).then(r,n)}o((c=c.apply(e,l||[])).next())})},__generator=this&&this.__generator||function(a,r){var n,o,l,e,s={label:0,sent:function(){if(1&l[0])throw l[1];return l[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,o&&(l=2&t[0]?o.return:t[0]?o.throw||((l=o.return)&&l.call(o),0):o.next)&&!(l=l.call(o,t[1])).done)return l;switch(o=0,l&&(t=[2&t[0],l.value]),t[0]){case 0:case 1:l=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,o=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(l=0<(l=s.trys).length&&l[l.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!l||t[1]>l[0]&&t[1]<l[3])){s.label=t[1];break}if(6===t[0]&&s.label<l[1]){s.label=l[1],l=t;break}if(l&&s.label<l[2]){s.label=l[2],s.ops.push(t);break}l[2]&&s.ops.pop(),s.trys.pop();continue}t=r.call(a,s)}catch(e){t=[6,e],o=0}finally{n=l=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__spreadArrays=this&&this.__spreadArrays||function(){for(var e=0,t=0,a=arguments.length;t<a;t++)e+=arguments[t].length;var r=Array(e),n=0;for(t=0;t<a;t++)for(var o=arguments[t],l=0,s=o.length;l<s;l++,n++)r[n]=o[l];return r};exports.__esModule=!0;var react_1=require("react"),react_bootstrap_1=require("react-bootstrap"),react_collapsible_1=require("react-collapsible"),mathjs_1=require("mathjs"),stats_module_1=require("../libs/stats.module"),Constant=require("../constant"),react_csv_1=require("react-csv"),xml_writer_1=require("xml-writer"),d3=require("d3"),headers=[{label:"Node",key:"Node"},{label:"Edge",key:"Edge"},{label:"FPS",key:"FPS"}],Sidebar=function(a){function e(e){var t=a.call(this,e)||this;return t.state={nodeData:[],edgeData:[],nodeCount:"",edgeCount:"",laplacian:mathjs_1.sparse([]),adjacencyMatrix:[],e:{},jsonFormat:!0,runBenchmark:!1,FPSData:[]},t.handleSubmit=t.handleSubmit.bind(t),t.readFiles=t.readFiles.bind(t),t.generateRandomGraph=t.generateRandomGraph.bind(t),t.generatePair=t.generatePair.bind(t),t.generateRandomData=t.generateRandomData.bind(t),t.refresh=t.refresh.bind(t),t.runTest=t.runTest.bind(t),t.runBenchmark=t.runBenchmark.bind(t),t.testFunc=t.testFunc.bind(t),t.sleep=t.sleep.bind(t),t.storeFPSResult=t.storeFPSResult.bind(t),t.d3TimingStudy=t.d3TimingStudy.bind(t),t}return __extends(e,a),e.prototype.handleSubmit=function(e){e.preventDefault(),this.props.setNodeEdgeData(this.state.nodeData,this.state.edgeData)},e.prototype.sleep=function(t){return new Promise(function(e){setTimeout(e,t)})},e.prototype.d3TimingStudy=function(r){return __awaiter(this,void 0,void 0,function(){var t,a,n,o;return __generator(this,function(e){return r.preventDefault(),800,t=d3.select("#graphDiv").append("canvas").attr("width","800px").attr("height","800px").node(),(a=document.getElementById("#graphDiv"))&&(a.style.color="white"),(n=t.getContext("2d"))?(n.fillStyle="white",o=d3.zoomIdentity,d3.json("./test_small_spec.json").then(function(e){console.log(e);var t,a=d3.forceSimulation(e.nodes).force("charge",d3.forceManyBody().strength(-40)).force("center",d3.forceCenter()).force("link",d3.forceLink(e.edges).distance(1).strength(.1));function r(){n.save(),n.clearRect(0,0,800,800),n.translate(o.x,o.y),n.scale(o.k,o.k),e.edges.forEach(function(e){n.beginPath(),n.moveTo(e.source.x,e.source.y),n.lineTo(e.target.x,e.target.y),n.stroke()}),e.nodes.forEach(function(e,t){n.beginPath(),n.arc(e.x,e.y,2,0,2*Math.PI,!0),n.fillStyle=e.col?"red":"black",n.fill()}),n.restore()}t=e,console.log(t.edges),a.on("tick",r)})):console.log("no 2d context found"),[2]})})},e.prototype.runBenchmark=function(u){return __awaiter(this,void 0,void 0,function(){var t,a,r,n,o,l,s,c;return __generator(this,function(e){switch(e.label){case 0:u.preventDefault(),20,a=(t=[1e6]).map(function(e){return 20*e}),(r=stats_module_1.default()).showPanel(0),r.dom.setAttribute("class","status"),document.body.appendChild(r.dom),this.setState({runBenchmark:!0}),(n=document.querySelectorAll("canvas")[0]).width=500,n.height=500,n.style.width="500px",n.style.height="500px",o=0,e.label=1;case 1:return o<t.length-1?(l=t[o].toString(),s=a[o].toString(),this.setState({nodeCount:l}),this.setState({edgeCount:s}),c=this.generateRandomData(t,a,o),this.setState({nodeData:c.nodes}),this.setState({edgeData:c.edges}),[4,this.testFunc(c,r)]):[3,4];case 2:e.sent(),e.label=3;case 3:return o++,[3,1];case 4:return this.setState({runBenchmark:!1}),n.width=800,n.height=800,n.style.width="800px",n.style.height="800px",[2]}})})},e.prototype.generatePair=function(e,t){function a(e,t){return e+Math.floor(Math.random()*(t-e))}for(var r=a(e,t),n=a(e,t);r===n;)n=a(e,t);return{source:r,target:n}},e.prototype.generateRandomData=function(e,t,a){var r=e[a],n=t[a];return this.generateRandomGraph(r,n)},e.prototype.generateRandomGraph=function(e,t){var a={nodes:[],edges:[]};a.nodes=Array(4*e).fill(0);for(var r=0;r<4*e;r+=4)a.nodes[r]=0,a.nodes[r+1]=Math.random(),a.nodes[r+2]=Math.random(),a.nodes[r+3]=1;var n,o=new Map;a.edges=Array(2*t).fill(0);for(r=0;r<2*t;r+=2){for(;n=this.generatePair(0,e),o.has(n.source+"_"+n.target););o.set(n.source+"_"+n.target,!0),o.set(n.target+"_"+n.source,!0),a.edges[r]=n.source,a.edges[r+1]=n.target}return a},e.prototype.refresh=function(e){for(var t=[],a=0;a<4*e;a+=4)t[a+1]=Math.random(),t[a+2]=Math.random();this.setState({nodeData:t}),this.props.setNodeEdgeData(t,this.state.edgeData)},e.prototype.storeFPSResult=function(e,t,a){e=e.toString(),t=t.toString(),a=a.toString(),this.setState({FPSData:__spreadArrays(this.state.FPSData,[[e,t,a]])})},e.prototype.testFunc=function(r,n){return __awaiter(this,void 0,void 0,function(){var t,a;return __generator(this,function(e){switch(e.label){case 0:return t=r.nodes.length/4,a=r.edges.length/2,[4,this.runTest(t,a,n)];case 1:return e.sent(),[2]}})})},e.prototype.runTest=function(l,s,c){return __awaiter(this,void 0,void 0,function(){var t,a,r,n,o=this;return __generator(this,function(e){switch(e.label){case 0:return(a=function(){c.begin(),o.refresh(l),c.end(),t=requestAnimationFrame(a)})(),[4,this.sleep(Constant.TIME_FOR_EACH_TEST)];case 1:return e.sent(),r=c.getFPSHistory(),n=r.reduce(function(e,t){return e+t},0)/r.length,this.storeFPSResult(l,s,n),cancelAnimationFrame(t),[2]}})})},e.prototype.readFiles=function(e){var l=this,s=e.target.files;console.log(s);var c={},u={},i=[],o=[],d=[],p=[],h=new FileReader;h.onload=function(e){for(var t=0,a=h.result.split("\n");t<a.length;t++){var r=a[t].split("\t");c[r[0]]&&c[r[1]]&&(o.push(u[r[0]],u[r[1]]),d[u[r[0]]][u[r[0]]]+=1,d[u[r[1]]][u[r[1]]]+=1,p[u[r[0]]][u[r[1]]]+=1,p[u[r[1]]][u[r[0]]]+=1)}l.setState({edgeData:o});var n=mathjs_1.subtract(mathjs_1.sparse(d),mathjs_1.sparse(p));console.log(n),l.setState({laplacian:n,adjacencyMatrix:p})};var f=new FileReader;f.onload=function(e){for(var t=0,a=f.result.split("\n");t<a.length;t++){var r=a[t].split("\t");c[r[0]]&&(u[r[0]]=i.length/4,i.push(parseFloat(c[r[0]]),parseFloat(r[1]),parseFloat(r[2]),parseFloat(r[3])))}l.setState({nodeData:i});for(var n=0;n<i.length/4;n++){d.push([]),p.push([]);for(var o=0;o<i.length/4;o++)d[n].push(0),p[n].push(0)}h.readAsText(s[2])};var n=new FileReader;n.onload=function(e){for(var t=0,a=n.result.split("\n");t<a.length;t++){var r=a[t];c[r.split("\t")[0]]=r.split("\t")[1]}console.log(c),f.readAsText(s[1])},n.readAsText(s[0])},e.prototype.readJson=function(e){var o=this,t=e.target.files,l=new FileReader,s=[],c=[];l.onload=function(e){var t=JSON.parse(l.result);console.log(t);for(var a=0;a<t.nodes.length;a++)t.nodes[a].x?s.push(0,t.nodes[a].x,t.nodes[a].y,1):s.push(0,Math.random(),Math.random(),1);for(a=0;a<t.edges.length;a++){var r=t.edges[a].source,n=t.edges[a].target;c.push(r,n)}o.setState({nodeData:s,edgeData:c})},l.readAsText(t[0])},e.prototype.applySpectral=function(){var e=mathjs_1.eigs(this.state.laplacian);console.log(e);for(var t=this.state.nodeData,a=mathjs_1.column(e.vectors,1),r=mathjs_1.column(e.vectors,2),n=mathjs_1.max(a),o=mathjs_1.max(r),l=mathjs_1.min(a),s=mathjs_1.min(r),c=0;c<t.length/4;c++)t[4*c+1]=(a.get([c,0])-l)/(n-l),t[4*c+2]=(r.get([c,0])-s)/(o-s);this.setState({nodeData:t}),this.props.setNodeEdgeData(t,this.state.edgeData)},e.prototype.onSaveXML=function(){var e=new xml_writer_1.default(!0);e.startDocument(),e.startElement("GeneTerrain"),e.startElement("Nodes");for(var t=0;t<this.state.nodeData.length;t+=4)e.startElement("Node"),e.writeAttribute("NodeID",t/4),e.writeAttribute("InputValue",this.state.nodeData[t]),e.writeAttribute("InputWeight",this.state.nodeData[t+3]),e.writeAttribute("NodeBackendX",this.state.nodeData[t+1]),e.writeAttribute("NodeBackendY",this.state.nodeData[t+2]),e.endElement("Node");e.endElement("Nodes"),e.startElement("Edges");for(t=0;t<this.state.edgeData.length;t+=2)e.startElement("Edge"),e.writeAttribute("BeginID",this.state.edgeData[t]),e.writeAttribute("EndID",this.state.edgeData[t+1]),e.endElement("Edge");e.endElement("Edges"),e.endDocument();var a=document.createElement("a"),r=new Blob([e.toString()],{type:"application/xml"});a.href=URL.createObjectURL(r),a.download="terrain.xml",document.body.appendChild(a),a.click()},e.prototype.render=function(){var t=this;return react_1.default.createElement("div",{className:"sidebar"},react_1.default.createElement("hr",null),react_1.default.createElement(react_bootstrap_1.Button,{className:"benchmark_test",onClick:this.runBenchmark},"Run Benchmark"),react_1.default.createElement("div",{style:{margin:10,color:"white"}},react_1.default.createElement("p",null,"Node count: ",this.state.nodeCount),react_1.default.createElement("p",null,"Edge count: ",this.state.edgeCount)),react_1.default.createElement(react_csv_1.CSVLink,{data:this.state.FPSData},"Download FPS data"),react_1.default.createElement("hr",null),react_1.default.createElement(react_bootstrap_1.Button,{className:"d3Timing_test",onClick:this.d3TimingStudy},"Run D3"),react_1.default.createElement(react_bootstrap_1.Form,{style:{color:"white"},onSubmit:this.handleSubmit},react_1.default.createElement(react_bootstrap_1.Form.Group,{controlId:"formFile",className:"mt-3 mb-3"},react_1.default.createElement(react_bootstrap_1.Form.Check,{defaultChecked:!0,onClick:function(){return t.setState({jsonFormat:!t.state.jsonFormat})},type:"checkbox",label:"Json Format"}),react_1.default.createElement(react_bootstrap_1.Form.Label,null,"Select Example Files"),react_1.default.createElement(react_bootstrap_1.Form.Control,{className:"form-control",type:"file",multiple:!0,onChange:function(e){t.state.jsonFormat?t.readJson(e):t.readFiles(e)}}),react_1.default.createElement(react_bootstrap_1.Button,{className:"mt-2",type:"submit",variant:"secondary",value:"Submit"},"Submit")),react_1.default.createElement(react_collapsible_1.default,{trigger:"Terrain Options"},react_1.default.createElement(react_bootstrap_1.Form.Group,null,react_1.default.createElement(react_bootstrap_1.Form.Label,null," Width Factor "),react_1.default.createElement("br",null),react_1.default.createElement("input",{type:"range",defaultValue:1e3,min:0,max:2e3,onChange:function(e){return t.props.setWidthFactor(parseFloat(e.target.value))}})),react_1.default.createElement(react_bootstrap_1.Form.Group,null,react_1.default.createElement(react_bootstrap_1.Form.Label,null," Peak and Valley Values "),react_1.default.createElement("br",null),react_1.default.createElement("input",{type:"range",defaultValue:.8,min:.5,max:1,step:.01,onChange:function(e){return t.props.setPeakValue(parseFloat(e.target.value))}}),react_1.default.createElement("input",{type:"range",defaultValue:.2,min:0,max:.5,step:.01,onChange:function(e){return t.props.setValleyValue(parseFloat(e.target.value))}})),react_1.default.createElement(react_bootstrap_1.Form.Group,null,react_1.default.createElement(react_bootstrap_1.Form.Check,{defaultChecked:!0,onClick:function(e){return t.props.setGlobalRange()},type:"checkbox",label:"Use Global Min/Max"}))),react_1.default.createElement(react_collapsible_1.default,{trigger:"Colormap Options"},react_1.default.createElement(react_bootstrap_1.Form.Row,null,react_1.default.createElement("div",null,"Valley"),react_1.default.createElement("input",{type:"range",defaultValue:45,min:1,max:60,step:1,onChange:function(e){return t.props.setColorValley(parseFloat(e.target.value))}})),react_1.default.createElement(react_bootstrap_1.Form.Row,null,react_1.default.createElement("div",null,"Hill"),react_1.default.createElement("input",{type:"range",defaultValue:90,min:61,max:120,step:1,onChange:function(e){return t.props.setColorHill(parseFloat(e.target.value))}})),react_1.default.createElement(react_bootstrap_1.Form.Row,null,react_1.default.createElement("div",null,"Mountain"),react_1.default.createElement("input",{type:"range",defaultValue:135,min:121,max:180,step:1,onChange:function(e){return t.props.setColorMountain(parseFloat(e.target.value))}}))),react_1.default.createElement(react_collapsible_1.default,{trigger:"Layers"},react_1.default.createElement(react_bootstrap_1.Form.Check,{defaultChecked:!1,onClick:function(e){return t.props.toggleTerrainLayer()},type:"checkbox",label:"Terrain Layer"}),react_1.default.createElement(react_bootstrap_1.Form.Check,{defaultChecked:!0,onClick:function(e){return t.props.toggleNodeLayer()},type:"checkbox",label:"Node Layer"}),react_1.default.createElement(react_bootstrap_1.Form.Check,{defaultChecked:!0,onClick:function(e){return t.props.toggleEdgeLayer()},type:"checkbox",label:"Edge Layer"})),react_1.default.createElement(react_collapsible_1.default,{trigger:"Force Directed Options"},react_1.default.createElement(react_bootstrap_1.Form.Label,null," Ideal Length and Cooling Factor "),react_1.default.createElement("br",null),react_1.default.createElement("input",{type:"range",defaultValue:.05,min:.001,max:.1,step:.001,onChange:function(e){return t.props.setIdealLength(parseFloat(e.target.value))}}),react_1.default.createElement("input",{type:"range",defaultValue:.9,min:.75,max:.999,step:.001,onChange:function(e){return t.props.setCoolingFactor(parseFloat(e.target.value))}})),react_1.default.createElement(react_bootstrap_1.Button,{onClick:function(e){return t.props.onSave()}},"Save Terrain"),react_1.default.createElement("br",null),react_1.default.createElement(react_bootstrap_1.Button,{onClick:function(e){return t.applySpectral()}},"Apply Spectral Layout"),react_1.default.createElement("br",null),react_1.default.createElement(react_bootstrap_1.Button,{onClick:function(e){return t.props.runForceDirected()}},"Run Force Directed Layout"),react_1.default.createElement("br",null),react_1.default.createElement(react_bootstrap_1.Button,{onClick:function(e){return t.onSaveXML()}},"Save Terrain to XML")))},e}(react_1.default.Component);exports.default=Sidebar;
//# sourceMappingURL=Sidebar.min.js.map
