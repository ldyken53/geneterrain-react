"use strict";var __awaiter=this&&this.__awaiter||function(e,n,s,u){return new(s=s||Promise)(function(t,r){function i(e){try{o(u.next(e))}catch(e){r(e)}}function a(e){try{o(u.throw(e))}catch(e){r(e)}}function o(e){e.done?t(e.value):function(t){return t instanceof s?t:new s(function(e){e(t)})}(e.value).then(i,a)}o((u=u.apply(e,n||[])).next())})},__generator=this&&this.__generator||function(r,i){var a,o,n,e,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;s;)try{if(a=1,o&&(n=2&t[0]?o.return:t[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,t[1])).done)return n;switch(o=0,n&&(t=[2&t[0],n.value]),t[0]){case 0:case 1:n=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,o=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(n=0<(n=s.trys).length&&n[n.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!n||t[1]>n[0]&&t[1]<n[3])){s.label=t[1];break}if(6===t[0]&&s.label<n[1]){s.label=n[1],n=t;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(t);break}n[2]&&s.ops.pop(),s.trys.pop();continue}t=i.call(r,s)}catch(e){t=[6,e],o=0}finally{a=n=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};exports.__esModule=!0;var wgsl_1=require("./wgsl"),greadibility_js_1=require("../greadibility.js"),ForceDirected=function(){function e(e){this.coolingFactor=.9,this.iterationCount=1e4,this.threshold=100,this.force=1e3,this.device=e,this.nodeDataBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),this.edgeDataBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.adjMatrixBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.laplacianBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.forceDataBuffer=this.device.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),this.createMatrixPipeline=e.createComputePipeline({compute:{module:e.createShaderModule({code:wgsl_1.create_adjacency_matrix}),entryPoint:"main"}}),this.createQuadTreePipeline=e.createComputePipeline({compute:{module:e.createShaderModule({code:wgsl_1.create_quadtree}),entryPoint:"main"}}),this.computeForcesPipeline=e.createComputePipeline({compute:{module:e.createShaderModule({code:wgsl_1.compute_forces}),entryPoint:"main"}}),this.applyForcesPipeline=e.createComputePipeline({compute:{module:e.createShaderModule({code:wgsl_1.apply_forces}),entryPoint:"main"}}),this.paramsBuffer=e.createBuffer({size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.positionReadBuffer=null}return e.prototype.formatToD3Format=function(e,t,r,i){for(var a=e.length,o=new Array(r),n=new Array(i),s=0;s<4*a;s+=4)o[s/4]={},o[s/4].index=s/4,o[s/4].name=(s/4).toString(),o[s/4].x=e[s+1],o[s/4].y=e[s+2];for(s=0;s<i;s+=2){n[s/2]={};var u=t[s],f=t[s+1];n[s/2].index=s/2,n[s/2].source={},n[s/2].source.index=u,n[s/2].source.name=u.toString(),n[s/2].source.x=o[u].x,n[s/2].source.y=o[u].y,n[s/2].target={},n[s/2].target.index=f,n[s/2].target.name=f.toString(),n[s/2].target.x=o[f].x,n[s/2].target.y=o[f].y}return{nodeArray:o,edgeArray:n}},e.prototype.runForces=function(v,_,C,w,S,A,D,R,x,M){return void 0===v&&(v=this.nodeDataBuffer),void 0===_&&(_=this.edgeDataBuffer),void 0===C&&(C=0),void 0===w&&(w=0),void 0===S&&(S=this.coolingFactor),void 0===A&&(A=.05),void 0===D&&(D=this.iterationCount),void 0===R&&(R=this.threshold),__awaiter(this,void 0,void 0,function(){var t,r,i,a,o,n,s,u,f,c,d,l,h,p,g,B,P,m,y,U,b,G;return __generator(this,function(e){switch(e.label){case 0:return 0==C||0==w?[2]:(console.log(A),console.log(S),this.coolingFactor=S,this.nodeDataBuffer=v,this.edgeDataBuffer=_,this.threshold=R,this.force=1e5,f=this.device.createBuffer({size:16,usage:GPUBufferUsage.COPY_SRC,mappedAtCreation:!0}),c=f.getMappedRange(),new Uint32Array(c).set([C,w]),new Float32Array(c).set([this.coolingFactor,A],2),f.unmap(),t=Math.ceil(C*C*4/32),this.adjMatrixBuffer=this.device.createBuffer({size:t,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),this.laplacianBuffer=this.device.createBuffer({size:C*C*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),(d=this.device.createCommandEncoder()).copyBufferToBuffer(f,0,this.paramsBuffer,0,16),r=this.device.createBindGroup({layout:this.createMatrixPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.edgeDataBuffer}},{binding:1,resource:{buffer:this.adjMatrixBuffer}},{binding:2,resource:{buffer:this.paramsBuffer}},{binding:3,resource:{buffer:this.laplacianBuffer}}]}),(h=d.beginComputePass()).setBindGroup(0,r),h.setPipeline(this.createMatrixPipeline),h.dispatch(1,1,1),h.endPass(),i=this.device.createBuffer({size:C*C*4,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),d.copyBufferToBuffer(this.adjMatrixBuffer,0,i,0,t),this.device.queue.submit([d.finish()]),[4,i.mapAsync(GPUMapMode.READ)]);case 1:e.sent(),a=i.getMappedRange(),o=new Int32Array(a),0,console.log(o),console.log(0),console.log(o.length),this.forceDataBuffer=this.device.createBuffer({size:2*C*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),n=[],s=performance.now(),u=this.device.createBindGroup({layout:this.applyForcesPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.nodeDataBuffer}},{binding:1,resource:{buffer:this.forceDataBuffer}}]}),e.label=2;case 2:return 0<D&&1e-4<this.coolingFactor&&0<=this.force?(D--,f=this.device.createBuffer({size:16,usage:GPUBufferUsage.COPY_SRC,mappedAtCreation:!0}),c=f.getMappedRange(),new Uint32Array(c).set([C,w]),new Float32Array(c).set([this.coolingFactor,A],2),f.unmap(),(d=this.device.createCommandEncoder()).copyBufferToBuffer(f,0,this.paramsBuffer,0,16),l=this.device.createBindGroup({layout:this.computeForcesPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.nodeDataBuffer}},{binding:1,resource:{buffer:this.adjMatrixBuffer}},{binding:2,resource:{buffer:this.forceDataBuffer}},{binding:3,resource:{buffer:this.paramsBuffer}}]}),(h=d.beginComputePass()).setBindGroup(0,l),h.setPipeline(this.computeForcesPipeline),h.dispatch(C,1,1),h.endPass(),(h=d.beginComputePass()).setBindGroup(0,u),h.setPipeline(this.applyForcesPipeline),h.dispatch(C,1,1),h.endPass(),this.positionReadBuffer=this.device.createBuffer({size:4*C*4,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),d.copyBufferToBuffer(this.nodeDataBuffer,0,this.positionReadBuffer,0,4*C*4),[4,this.device.queue.submit([d.finish()])]):[3,5];case 3:return e.sent(),p=performance.now(),[4,this.device.queue.onSubmittedWorkDone()];case 4:return e.sent(),g=performance.now(),console.log("iteration time "+(g-p)),n.push(g-p),this.coolingFactor=this.coolingFactor*S,[3,2];case 5:return[4,this.positionReadBuffer.mapAsync(GPUMapMode.READ)];case 6:return e.sent(),B=this.positionReadBuffer.getMappedRange(),P=new Float32Array(B),m=this.formatToD3Format(P,M,C,w),y=m.nodeArray,U=m.edgeArray,console.log(U.length),console.log(y,U),console.log(greadibility_js_1.greadability(y,U)),b=performance.now(),G=n.reduce(function(e,t){return e+t})/n.length,x.current.innerText="Completed in "+n.length+" iterations with total time "+(b-s)+" and average iteration time "+G,[2]}})})},e}();exports.default=ForceDirected;
//# sourceMappingURL=force_directed.min.js.map
