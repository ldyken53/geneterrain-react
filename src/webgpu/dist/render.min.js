"use strict";var __awaiter=this&&this.__awaiter||function(e,o,u,s){return new(u=u||Promise)(function(t,r){function i(e){try{a(s.next(e))}catch(e){r(e)}}function n(e){try{a(s.throw(e))}catch(e){r(e)}}function a(e){e.done?t(e.value):function(t){return t instanceof u?t:new u(function(e){e(t)})}(e.value).then(i,n)}a((s=s.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(r,i){var n,a,o,e,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;u;)try{if(n=1,a&&(o=2&t[0]?a.return:t[0]?a.throw||((o=a.return)&&o.call(a),0):a.next)&&!(o=o.call(a,t[1])).done)return o;switch(a=0,o&&(t=[2&t[0],o.value]),t[0]){case 0:case 1:o=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,a=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(o=0<(o=u.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){u.label=t[1];break}if(6===t[0]&&u.label<o[1]){u.label=o[1],o=t;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(t);break}o[2]&&u.ops.pop(),u.trys.pop();continue}t=i.call(r,u)}catch(e){t=[6,e],a=0}finally{n=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};exports.__esModule=!0;var ez_canvas_controller_1=require("./ez_canvas_controller"),terrain_generator_1=require("./terrain_generator"),wgsl_1=require("./wgsl"),file_saver_1=require("file-saver"),force_directed_1=require("./force_directed"),Renderer=function(){function e(e,u,s,t,r,i,f,n){var a=this;if(this.uniform2DBuffer=null,this.terrainGenerator=null,this.forceDirected=null,this.bindGroup2D=null,this.nodeBindGroup=null,this.edgeBindGroup=null,this.nodeDataBuffer=null,this.edgeDataBuffer=null,this.testFrame=null,this.colorTexture=null,this.viewBoxBuffer=null,this.nodePipeline=null,this.edgePipeline=null,this.nodeLength=1,this.edgeLength=1,this.rangeBuffer=null,this.nodeToggle=!0,this.terrainToggle=!1,this.edgeToggle=!0,this.canvasSize=null,this.idealLength=.05,this.coolingFactor=.9,this.edgeList=[0],this.iterRef=n,this.colormapImage=r,this.outCanvasRef=i,this.device=u,null!==s.current){var d=s.current.getContext("webgpu"),o=window.devicePixelRatio||1,c=[s.current.clientWidth*o,s.current.clientHeight*o],g=d.getPreferredFormat(e);this.canvasSize=[s.current.width,s.current.height],d.configure({device:u,format:g,compositingAlphaMode:"premultiplied",size:c}),this.edgeList=[0],this.edgeDataBuffer=u.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST,mappedAtCreation:!0});new Float32Array(this.edgeDataBuffer.getMappedRange()).set([0,0,.01,.01]),this.edgeDataBuffer.unmap(),this.edgePipeline=u.createRenderPipeline({vertex:{module:u.createShaderModule({code:wgsl_1.edge_vert}),entryPoint:"main",buffers:[]},fragment:{module:u.createShaderModule({code:wgsl_1.edge_frag}),entryPoint:"main",targets:[{format:g,blend:{color:{srcFactor:"one",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha"}}}]},primitive:{topology:"line-list"},multisample:{count:4}}),this.rangeBuffer=this.device.createBuffer({size:8,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC});var l=u.createBuffer({size:48,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0});new Float32Array(l.getMappedRange()).set([1,-1,-1,-1,-1,1,1,-1,-1,1,1,1]),l.unmap();var h=u.createBuffer({size:16,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0});new Float32Array(h.getMappedRange()).set([0,0,1,1]),h.unmap(),this.nodeDataBuffer=u.createBuffer({size:16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC,mappedAtCreation:!0}),new Float32Array(this.nodeDataBuffer.getMappedRange()).set([.5,.5,.5,.5]),this.nodeDataBuffer.unmap(),this.nodePipeline=u.createRenderPipeline({vertex:{module:u.createShaderModule({code:wgsl_1.node_vert}),entryPoint:"main",buffers:[{arrayStride:8,attributes:[{format:"float32x2",offset:0,shaderLocation:0}]}]},fragment:{module:u.createShaderModule({code:wgsl_1.node_frag}),entryPoint:"main",targets:[{format:g,blend:{color:{srcFactor:"one",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha"}}}]},primitive:{topology:"triangle-list"},multisample:{count:4}});var p=u.createRenderPipeline({vertex:{module:u.createShaderModule({code:wgsl_1.display_2d_vert}),entryPoint:"main",buffers:[{arrayStride:16,attributes:[{format:"float32x4",offset:0,shaderLocation:0}]}]},fragment:{module:u.createShaderModule({code:wgsl_1.display_2d_frag}),entryPoint:"main",targets:[{format:g}]},primitive:{topology:"triangle-list"},multisample:{count:4}}),B=u.createBuffer({size:96,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0});new Float32Array(B.getMappedRange()).set([1,-1,0,1,-1,-1,0,1,-1,1,0,1,1,-1,0,1,-1,1,0,1,1,1,0,1]),B.unmap(),this.uniform2DBuffer=u.createBuffer({size:8,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),u.queue.writeBuffer(this.uniform2DBuffer,0,new Float32Array([.8,.2]),0,2);var m=u.createBuffer({size:8,usage:GPUBufferUsage.UNIFORM,mappedAtCreation:!0});new Uint32Array(m.getMappedRange()).set(this.canvasSize),m.unmap(),this.colorTexture=u.createTexture({size:[t.width,t.height,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT}),u.queue.copyExternalImageToTexture({source:t},{texture:this.colorTexture},[t.width,t.height,1]),this.terrainGenerator=new terrain_generator_1.default(u,this.canvasSize[0],this.canvasSize[1]),this.forceDirected=new force_directed_1.default(u),this.bindGroup2D=u.createBindGroup({layout:p.getBindGroupLayout(0),entries:[{binding:0,resource:this.colorTexture.createView()},{binding:1,resource:{buffer:this.terrainGenerator.pixelValueBuffer}},{binding:2,resource:{buffer:this.uniform2DBuffer}},{binding:3,resource:{buffer:m}}]}),this.viewBoxBuffer=u.createBuffer({size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),u.queue.writeBuffer(this.viewBoxBuffer,0,new Float32Array([0,0,1,1]),0,4);var v=[0,0,1,1],w=[0,0,1,1],_=new ez_canvas_controller_1.Controller,P=this.terrainGenerator,y=this;_.mousemove=function(e,t,r){if(1==r.buttons){var i=[(t[0]-e[0])*(v[2]-v[0])/y.canvasSize[0],(e[1]-t[1])*(v[3]-v[1])/y.canvasSize[1]];w=[w[0]-i[0],w[1]-i[1],w[2]-i[0],w[3]-i[1]],(Math.abs(w[0]-v[0])>.03*(v[2]-v[0])||Math.abs(w[1]-v[1])>.03*(v[3]-v[1]))&&(v=w,y.terrainToggle&&P.computeTerrain(void 0,void 0,v,y.rangeBuffer,y.nodeLength),u.queue.writeBuffer(y.viewBoxBuffer,0,new Float32Array(v),0,4))}},_.wheel=function(e){var t=[e/1e3,e/1e3];.01<(w=[w[0]+t[0],w[1]+t[1],w[2]-t[0],w[3]-t[1]])[2]-w[0]&&.01<w[3]-w[1]?(v=w,y.terrainToggle&&P.computeTerrain(void 0,void 0,v,y.rangeBuffer,y.nodeLength),u.queue.writeBuffer(y.viewBoxBuffer,0,new Float32Array(v),0,4)):w=v},_.registerForCanvas(s.current),this.nodeBindGroup=u.createBindGroup({layout:this.nodePipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.viewBoxBuffer}},{binding:1,resource:{buffer:this.nodeDataBuffer}}]}),this.edgeBindGroup=u.createBindGroup({layout:this.edgePipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.viewBoxBuffer}},{binding:1,resource:{buffer:this.nodeDataBuffer}},{binding:2,resource:{buffer:this.edgeDataBuffer}}]});var b=u.createTexture({size:c,sampleCount:4,format:g,usage:GPUTextureUsage.RENDER_ATTACHMENT}).createView(),G=(y=this,0),T=1e3;this.testFrame=function(){return __awaiter(a,void 0,void 0,function(){var t,r,i;return __generator(this,function(e){switch(e.label){case 0:return t=this.device.createCommandEncoder(),r={colorAttachments:[{view:b,resolveTarget:d.getCurrentTexture().createView(),loadValue:{r:1,g:1,b:1,a:1},storeOp:"discard"}]},(i=t.beginRenderPass(r)).setPipeline(this.edgePipeline),i.setVertexBuffer(0,h),i.setBindGroup(0,this.edgeBindGroup),i.draw(2,this.edgeLength/2),i.setPipeline(this.nodePipeline),i.setVertexBuffer(0,l),i.setBindGroup(0,this.nodeBindGroup),i.draw(6,this.nodeLength),i.endPass(),u.queue.submit([t.finish()]),[4,u.queue.onSubmittedWorkDone()];case 1:return e.sent(),[4,u.queue.onSubmittedWorkDone()];case 2:return e.sent(),[2]}})})},requestAnimationFrame(function o(){return __awaiter(this,void 0,void 0,function(){var t,r,i,n,a;return __generator(this,function(e){switch(e.label){case 0:return t=performance.now(),s.current?(r=u.createCommandEncoder(),i={colorAttachments:[{view:b,resolveTarget:d.getCurrentTexture().createView(),loadValue:{r:1,g:1,b:1,a:1},storeOp:"discard"}]},n=r.beginRenderPass(i),y.terrainToggle&&(n.setPipeline(p),n.setVertexBuffer(0,B),n.setBindGroup(0,y.bindGroup2D),n.draw(6,1,0,0)),y.edgeToggle&&(n.setPipeline(y.edgePipeline),n.setBindGroup(0,y.edgeBindGroup),n.draw(2,y.edgeLength/2,0,0)),y.nodeToggle&&(n.setPipeline(y.nodePipeline),n.setVertexBuffer(0,l),n.setBindGroup(0,y.nodeBindGroup),n.draw(6,y.nodeLength,0,0)),n.endPass(),u.queue.submit([r.finish()]),[4,u.queue.onSubmittedWorkDone()]):[2];case 1:return e.sent(),a=performance.now(),T-(a-t)<0?(f.current.innerText="FPS: "+G,T=T-(a-t)+1e3,G=0):T-=a-t,G+=1,requestAnimationFrame(o),[2]}})})})}}return e.prototype.setNodeEdgeData=function(t,r){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return this.edgeList=r,this.nodeDataBuffer.destroy(),this.edgeDataBuffer.destroy(),this.nodeDataBuffer=this.device.createBuffer({size:4*t.length,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC,mappedAtCreation:!0}),new Float32Array(this.nodeDataBuffer.getMappedRange()).set(t),this.nodeDataBuffer.unmap(),this.edgeDataBuffer=this.device.createBuffer({size:4*r.length,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.STORAGE,mappedAtCreation:!0}),new Uint32Array(this.edgeDataBuffer.getMappedRange()).set(r),this.edgeDataBuffer.unmap(),this.edgeBindGroup=this.device.createBindGroup({layout:this.edgePipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.viewBoxBuffer}},{binding:1,resource:{buffer:this.nodeDataBuffer}},{binding:2,resource:{buffer:this.edgeDataBuffer}}]}),this.nodeBindGroup=this.device.createBindGroup({layout:this.nodePipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.viewBoxBuffer}},{binding:1,resource:{buffer:this.nodeDataBuffer}}]}),this.edgeLength=r.length,this.nodeLength=t.length/4,[4,this.testFrame()];case 1:return e.sent(),[2]}})})},e.prototype.setWidthFactor=function(e){this.terrainGenerator.computeTerrain(void 0,e,void 0,this.rangeBuffer,this.nodeLength)},e.prototype.setPeakValue=function(e){this.device.queue.writeBuffer(this.uniform2DBuffer,0,new Float32Array([e]),0,1)},e.prototype.setValleyValue=function(e){this.device.queue.writeBuffer(this.uniform2DBuffer,4,new Float32Array([e]),0,1)},e.prototype.setCoolingFactor=function(e){this.coolingFactor=e},e.prototype.setIdealLength=function(e){this.idealLength=e},e.prototype.setGlobalRange=function(){this.rangeBuffer?this.rangeBuffer=null:this.rangeBuffer=this.device.createBuffer({size:8,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC})},e.prototype.runForceDirected=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return this.forceDirected.runForces(this.nodeDataBuffer,this.edgeDataBuffer,this.nodeLength,this.edgeLength,this.coolingFactor,this.idealLength,1e3,300,this.iterRef,this.edgeList),[2]})})},e.prototype.toggleTerrainLayer=function(){this.terrainToggle=!this.terrainToggle},e.prototype.toggleNodeLayer=function(){this.nodeToggle=!this.nodeToggle},e.prototype.toggleEdgeLayer=function(){this.edgeToggle=!this.edgeToggle},e.prototype.setColormap=function(e,t){this.device.queue.copyExternalImageToTexture({source:e},{texture:this.colorTexture},[e.width,e.height,1]),this.colormapImage=t},e.prototype.onSave=function(){return __awaiter(this,void 0,void 0,function(){var t,r,i,n,a,o,u,s,f,d,c,g,l,h;return __generator(this,function(e){switch(e.label){case 0:return t=this.outCanvasRef.current.height,r=this.outCanvasRef.current.width,i=this.device.createBuffer({size:r*t*4,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),console.log(r,t),(n=this.device.createCommandEncoder()).copyBufferToBuffer(this.terrainGenerator.pixelValueBuffer,0,i,0,r*t*4),a=n.finish(),this.device.queue.submit([a]),[4,i.mapAsync(GPUMapMode.READ)];case 1:for(e.sent(),o=i.getMappedRange(),u=new Float32Array(o),(s=this.outCanvasRef.current.getContext("2d")).drawImage(this.colormapImage,0,0),f=s.getImageData(0,0,180,1).data,d=s.createImageData(r,t),c=0;c<t;c++)for(g=0;g<r;g++)l=g+c*r,h=4*Math.trunc(180*u[g+(t-1-c)*r]),d.data[4*l]=f[h],d.data[4*l+1]=f[1+h],d.data[4*l+2]=f[2+h],d.data[4*l+3]=f[3+h];return s.putImageData(d,0,0),this.outCanvasRef.current.toBlob(function(e){file_saver_1.saveAs(e,"terrain.png")},"image/png"),[2]}})})},e}();exports.default=Renderer;
//# sourceMappingURL=render.min.js.map
